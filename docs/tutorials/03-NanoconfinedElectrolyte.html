<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width,
        initial-scale=1, minimum-scale=1.0, shrink-to-fit=no">
        <link href="../figures/favicon-32x32.png" rel="icon" />
        <title>Nanoconfined electrolyte</title>
        <meta name="description" content="Nanoconfined electrolyte">
        <meta name="author" content="Simon Gravelle">
        <link rel="stylesheet" type="text/css" href="../assets_tutorials/vendor/bootstrap/css/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css" href="../assets_tutorials/vendor/font-awesome/css/all.min.css" />
        <link rel="stylesheet" type="text/css" href="../assets_tutorials/css/stylesheet.css" />
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-W1WGEC5GQ8"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-W1WGEC5GQ8');
        </script>
        <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </head>
    <body data-spy="scroll" data-target=".idocs-navigation" data-offset="125">
        <div id="main-wrapper">
            <header id="header" class="sticky-top">
                <nav class="primary-menu navbar navbar-expand-lg navbar-dropdown-dark">
                    <div class="container-fluid">
                        <a class="logo ml-md-3" href="../index.html" title="LAMMPS tutorials">
                            <img src="../figures/logo.png" alt="LAMMPS tutorials" height="60"/>
                        </a>
                        <div id="header-nav" class="collapse navbar-collapse justify-content-end">
                            <ul class="navbar-nav">
                                <li>
                                    <a href="../index.html">All tutorials</a>
                                </li>
                                <li>
                                    <a href="../miscellaneous/contact.html">Contact me</a>
                                </li>
                            </ul>
                        </div>
                        <ul class="social-icons social-icons-sm ml-lg-2 mr-2">
                            <li class="social-icons-twitter"><a data-toggle="tooltip"
                            href="https://twitter.com/GravelleSimon" target="_blank"
                            title="" data-original-title="Twitter">
                            <i class="fab fa-twitter"></i></a></li>
                            <li class="social-icons-twitter"><a data-toggle="tooltip"
                            href="https://gitlab.com/sgravelle" target="_blank"
                            title="" data-original-title="Gitlab">
                            <i class="fab fa-gitlab"></i></i></a></li>
                            <li class="social-icons-twitter"><a data-toggle="tooltip"
                            href="https://github.com/simongravelle" target="_blank"
                            title="" data-original-title="Github">
                            <i class="fab fa-github"></i></i></a></li>
                            <li class="social-icons-twitter"><a data-toggle="tooltip"
                            href="https://www.youtube.com/c/SimonGravelle"
                            target="_blank" title="" data-original-title="Youtube">
                            <i class="fab fa-youtube"></i></i></a></li>
                        </ul>
                    </div>
                </nav>
            </header>
            <div class="idocs-navigation bg-light">
                <ul class="nav flex-column ">
                    <li class="nav-item"><a class="nav-link active"
                    href="#intro">Getting Started</a></li>
                    <li class="nav-item"><a class="nav-link active"
                    href="#generation">System generation</a></li>
                    <li class="nav-item"><a class="nav-link"
                    href="#minimisation">Energy minimisation</a></li>
                    <li class="nav-item"><a class="nav-link"
                    href="#equilibration">System equilibration</a></li>
                    <li class="nav-item"><a class="nav-link"
                        href="#shearing">Shearing</a></li>
                    <li class="nav-item"><a class="nav-link"
                    href="#further">Going further</a></li>
                </ul>
            </div>
            <div class="idocs-content">
                <div class="container">
                    <section id="intro">
                        <h1>Nanosheared electrolyte</h1>
                        <h3>Molecular dynamics simulation of an aqueous NaCl solution sheared
                        between two solid walls</h3>
                        <p>
                            <img src="../figures/03-NanoshearedElectrolyte/nanoconfinedwater.png"
                            class="img-fluid" alt="Responsive image">
                        </p>
                        <p>
                            <b>The objective of this tutorial</b> is to use molecular
                            dynamics and simulate an electrolyte confined between two rigid
                            carbon walls. There are four main parts to this tutorial:
                            <ul>
                                <li> 
                                    <a href="#generation">System generation - </a>
                                    First, the electrolyte and the
                                    two walls are generated using LAMMPS internal commands.
                                </li>
                                <li> 
                                    <a href="#minimisation">Minimisation - </a>
                                    Seconds, an energy minimisation is performed to
                                    bring the system in a more favorable configuration.
                                </li>
                                <li> 
                                    <a href="#equilibration">System equilibration - </a>
                                    Third, the system is equilibrated at a
                                    pressure of 1 atm and temperature of 300 K.
                                </li>
                                <li>
                                    <a href="#shearing">Induced shearing - </a>
                                    Finally, a shearing of the solution is induced by the 
                                    motion of the two walls.
                                </li>
                            </ul>
                        </p>
                    </section>
                    <section>
                        <div id="boxtype2">
                            If you are new to LAMMPS, I recommend you to follow
                            <a href="01-SimpleMolecularSimulation.html">this simpler tutorial</a> first.
                        </div>
                        <div id="boxtype1">
                            <a href="../miscellaneous/contact.html">Contact me</a> if you have any question about these tutorials
                            (or about your own project). 
                        </div>
                        <div id="boxtype2">
                                You can <a href="../miscellaneous/contact.html">support the creation</a> of content for LAMMPS for 1 euro 
                                per month (and access extra content and tips).
                        </div>
                    </section>
                    <section id="generation">
                        <h2>System generation</h2>
                        <p>
                            Create a new folder called SystemCreation/. Open a
                            blank page in it using a text editor, and call it input.lammps. 
                            Copy the following lines into input.lammps:
                            <pre><code># LAMMPS input file
units real
atom_style full
bond_style harmonic
angle_style harmonic
pair_style lj/cut/tip4p/long 1 2 1 1 0.1546 12.0
kspace_style pppm/tip4p 1.0e-4</code></pre>
                        </p>
                        <p>
                            These commands have been already seen in <a href="02-PEGinH2O.html">tutorial number 2</a>.
                        </p>
                        <p>
                            Let us create the box: copy the following lines
                            into the input file:
                            <pre><code># ------------- System definition
lattice fcc 4.04
region box block -4 4 -4 4 -13 13
create_box 5 box &
            bond/types 1 &
            angle/types 1 &
            extra/bond/per/atom 2 &
            extra/angle/per/atom 1 &
            extra/special/per/atom 2</code></pre>
                        </p>
                        <p>
                            <b>Explanations:</b> The 'lattice' command defines the
                            unit cell. Here face-centered cubic (fcc) with a scale factor of 4.04 has been chosen for the future
                            positioning of the atoms of the walls.
                            The 'region' command defines a geometric region of space,
                            and by choosing 'xlo=-4' and 'xhi=4', and because we have
                            previously chosen a lattice with scale factor of 4.04,
                            the region box extends from -16.16 to 16.16 Ångström
                            (units of lengths are in Ångstrom because we have chosen the
                            unit style 'real'). Finally, the 'create_box' command creates
                            a simulation box with 5 types of atoms in the simulation:
                            oxygen and hydrogen atoms of the water, Na, Cl, and the
                            atoms of the walls.
                        </p>
                        <p>
                            The create box command extends over 6 lines thanks to the '&'
                            character. The second and third lines are used to specify that
                            the simulation contains 1 type of bond and 1 type of angle
                            (for the water molecule). The parameters of these bond and
                            angle constraints will be given later. The three last lines
                            are for memory allocation.
                        </p>
                        <p>
                            We can now add atoms to the system. First, we create two
                            sub-regions corresponding respectively to the two solid walls,
                            and create a larger region from the union of the two regions.
                            Then we create atoms of type 5 within the two regions:.
                            <pre><code># create the walls
region rbotwall block -4 4 -4 4 -12 -10
region rtopwall block -4 4 -4 4 10 12
region rwall union 2 rbotwall rtopwall
create_atoms 5 region rwall</code></pre>
                        </p>
                        <div id="boxtype1">
                            Atoms will be placed at the positions of the previously defined lattice. 
                        </div>
                        <p>
                            In order to add the water molecules, we first need to
                            download the 
                            <a href="https://raw.githubusercontent.com/lammpstutorials/lammpstutorials.github.io/main/inputs/03-NanoconfinedElectrolyte/SystemCreation/TIP4P2005.txt"
                            target="_blank" class="removelinkdefault">TIP4P2005.txt</a> file
                            and place it in the same folder. It contains all the
                            necessary information about the water molecule, such as
                            positions, bonds, and angle. Then, add the following
                            lines to input.lammps:
                            <pre><code># create the fluid
region rliquid block -4 4 -4 4 -9 9
molecule h2omol TIP4P2005.txt
lattice sc 4.04
create_atoms 0 region rliquid mol h2omol 482793</code></pre>
                        </p>
                        <p>
                            <b>Explanations:</b> With the last four lines,
                            a region used to deposit the
                            water is created on the last defined lattice, which is
                            'fcc 4.04'. Then, on the next line, we define
                            a new simple cubic lattice in order to position the water
                            molecules on it, with a distance of 4.04 Ångstroms between
                            each water molecule (note: the new lattice replaces the 
                            previous one as LAMMPS reads a script from top to bottom). Note 
                            that 4.04 Ångstroms is larger than
                            the typical equilibrium distance between water molecules
                            in a liquid, but this will allow us to insert ions more
                            safely. Then, the 'molecule' command opens the 'TIP4P2005.txt'
                            file, and name the associated molecule 'h2omol'.
                            Finally, molecules are created on the sc lattice by the
                            'create_atoms' command. The first parameter is '0' because
                            we use the atom id from the 'TIP4P2005.txt' file. The number
                            '482793' is a seed that is required by LAMMPS, it can
                            be any positive integer. 
                        </p>
                        <p>  
                            Finally, let us deposit 20 ions
                            (10 Na\(^+\), 10 Cl\(^-\)) in between the water molecules by adding
                            these two lines to input.01.lammps:
                            <pre><code>fix mydep1 all deposit 10 3 1 56513 region rliquid near 0.3
fix mydep2 all deposit 10 4 1 58613 region rliquid near 0.3</code></pre>
                        </p>
                        <p>
                            Each 'fix deposit' will add one ion at a random position
                            within the 'rliquid' region every timestep. So we can just
                            make a very short simulation of 10 timesteps and save
                            the generated configuration. Feel free to increase the salt
                            concentration by increasing both number of steps and number of 
                            desired ions in the 'deposit' fixes.
                        </p>
                        <p>
                            We need to define the parameters of the simulation: the mass
                            of the 6 atoms (O, H, Na\(^+\), Cl\(^-\), and wall), the pairwise interaction
                            parameters (here the parameters for the Lennard-Jones
                            potential), and the bond and angle parameters. Copy the
                            following line into input.lammps:
                            <pre><code># settings
include	../PARM.lammps</code></pre>
                        </p>
                        <p>
                            Create a new text file, call it 'PARM.lammps', and copy
                            it next to the SystemCreation/ folder. Copy
                            the following lines into PARM.lammps:
                            <pre><code># Parameter file
mass 1 15.9994 # water
mass 2 1.008 # water
mass 3 28.990 # ion
mass 4 35.453 # ion
mass 5 26.9815 # wall

pair_coeff 1 1 0.185199 3.1589 # water
pair_coeff 2 2 0.0 0.0 # water
pair_coeff 3 3 0.04690 2.4299 # ion
pair_coeff 4 4 0.1500 4.04470 # ion
pair_coeff 5 5 11.697 2.574 # wall

bond_coeff 1 0 0.9572 # water

angle_coeff 1 0 104.52 # water</code></pre>
                        </p>
                        <p>
                            <b>Explanations:</b> The parameters for water (mass 1,
                            mass 2, pair_coeff 1 1, pair coeff 2 2, bond_coeff 1 and
                            angle_coeff 1) are given by the TIP4P/2005 force field,
                            the parameters for Na\(^+\) and Cl\(^-\) (mass 3, mass 4, pair_coeff 3 3,
                            pair_coeff 4 4) are given by the CHARMM-27 force field,
                            and the parameters for the wall (mass 5 and
                            pair_coeff 5 5) are parameters for the wall atoms. 
                            Each 'mass' command assigns a mass in grams/mole to
                            an atom type. Each 'pair_coeff' assigns respectively
                            the depth of the potential in Kcal/mole, and the distance
                            at which the particle-particle potential energy in Ångstrom.
                        </p>
                        <div id="boxtype1">
                            Only assigned pairwise interaction between atoms of
                            identical type we assign. By default, LAMMPS calculates the pair
                            coefficients for the interactions between atoms of different types (i and j)
                            by using geometrical average:
                            \[ \epsilon_{ij} = (\epsilon_i + \epsilon_j)/2, \]
                            \[ \sigma_{ij} = (\sigma_i + \sigma_j)/2. \]
                        </div>
                        <div id="boxtype2">
                            Other rules for cross coefficients can be
                            set with the 'pair_modify' command, but for the sake of
                            simplicity, let us keep the default option here.
                        </div>
                        <p>
                            The bond coefficient (here for the O-H bond of the water
                            molecule) sets respectively the energy of the harmonic
                            potential and the equilibrium distance in Ångstrom.
                            The value is '0' for the energy, because we are going
                            to use a rigid model for the water molecule. The shape of
                            the molecule will be preserved later by the shake algorithm.
                            Similarly, the angle coefficient (here for
                            the H-O-H angle of the water molecule) sets the energy of
                            the harmonic potential (also 0) and the equilibrium angle 
                            is in degree.
                        </p>
                        <p>
                            Finally, add the following lines to the input file:
                            <pre><code># run
run 10

set type 3 charge 1.0
set type 4 charge -1.0

write_data system.data
write_dump all atom dump.lammpstrj</code></pre>
                        </p>
                        <p>
                            <b>Explanations:</b> With 'run 10', the
                            simulation will run for 10 timesteps. 
                        </p>
                        <div id="boxtype1"> 
                            The value of the
                            timestep (1 fs by default) does not matter yet because
                            the atoms are not moving. 
                        </div>
                        <p>
                            We also need to specify the charge
                            of the newly added ions, which is done using the 'set'
                            commands. The write 'data_file' finally creates a file named
                            'system.data' containing all the information
                            required to restart the simulation from the final configuration
                            generated by this input file. The 'write_dump' command print the 
                            final positions of the atoms, and can be used with VMD or ovito.
                        </p>
                        <p>
                            This input script is ready to be ran with LAMMPS. When the run is over, 
                            open the log file and make sure that atoms have been created (look 
                            for lines like 'Created 3648 atoms'), or just look at the dump file with VMD:
                        </p>
                        <p>
                            <img src="../figures/03-NanoshearedElectrolyte/systemcreation.png" 
                            class="img-fluid" style="width:80%" alt="Nanoconfined electrolyte initial system">
                            <br>
                            <small> Left: side view. Periodic images are represented in light color. 
                                Water molecules are in red and white, Na\(^+\) ions in purple, Cl\(^+\) ions in lime, and walls in gray. 
                                Right: top view. Note the absence of atomic defect at the cell boundaries. </small>
                        </p>
                        <div id="boxtype2"> 
                            Always check that your system has been correctly created by showing 
                            the periodic images. Atomic defects often occur at the boundary.
                        </div>
                    </section>
                    <section id="minimisation">
                        <h2>Energy minimisation</h2>
                        <div id="boxtype2"> 
                            <b>Why is this step necessary?</b>
                            <br><br>
                            It is clear from the way the system has been created that
                            the atoms are not at equilibrium distances from each others.
                            Indeed, some of the ions added using the 'fix deposit'
                            commands are too close to the water molecules. If we were
                            to start a 'normal' molecular dynamics simulation now
                            (i.e. solve the equations of motion) with a 'normal'
                            timestep (1  or 2 femto-seconds), the atoms would exert
                            huge forces on each others, accelerate brutally, and the simulation would fail (you can try). 
                        </div>
                        <div id="boxtype1"> 
                            MD simulations failing due to overlapping atoms
                            are extremely common, and I can almost guarantee that you will face 
                            a similar issue at some point. If it occurs, you can either 
                            <ul>
                                <li>
                                    (1) 
                                delete the overlapping atoms (like we did in <a href="02-PEGinH2O.html">tutorial number 2</a>),
                                </li>
                                <li>
                                    (2) move the atoms to more 
                                    reasonable distances using some kind of energy minization before 
                                    the simulation starts (here, this is what we do).
                                </li>
                            </ul>
                        </div>
                        <div id="boxtype2">
                            Support the creation of content for LAMMPS for just <a href="../miscellaneous/contact.html">1 euro per month</a> (and access 
                            additional content and tips).
                        </div>
                        <p>
                            Here we need to find a way to move the atoms
                            and place them in a more favorable position before starting
                            the simulation. This step is called 'energy minimization',
                            and is often necessary. 
                        </p>
                        <h4><b>Implementation</b></h4>
                        <p>
                            To perform the energy minimization with our system, let us create a 
                            new folder named Minimization/, and create a new input file named input.lammps in it.
                            The first lines will be very similar to the previous input file:
                            <pre><code># Initialisation
boundary p p p
units real
atom_style full
bond_style harmonic
angle_style harmonic
pair_style lj/cut/tip4p/long 1 2 1 1 0.1546 12.0
kspace_style pppm/tip4p 1.0e-4

# System definition
read_data ../SystemCreation/system.data

# settings
include ../PARM.lammps</code></pre>
                        </p>
                        <p>
                            The only difference with the previous input is that, instead
                            of creating a new box and atoms, we open and read the
                            previously created file system.data which contains
                            the definition of the simulation box and the positions
                            of the atoms. 
                        </p>
                        <p>  
                            Next, let us create a group for the water:
                            <pre><code>group gH2O type 1 2</code></pre>
                        </p>
                        <p>
                            Creating groups allows us to apply different dynamics
                            to the liquid and to the walls.
                        </p>
                        <p>
                            Let us print the atoms positions in a dump file:
                            <pre><code>dump mydmp all atom 1000 dump.lammpstrj</code></pre>
                        </p>
                        <p>
                            Now, we can include the most important commands for the minimization:
                            <pre><code>fix mynve all nve/limit 0.1
fix myber all temp/berendsen 1 1 1</code></pre>
                        </p>
                        <p>
                            The fix 'nve/limit' performs
                            constant NVE integration to update positions and velocities
                            of the atoms at each timestep, but limit the maximum motion an atom 
                            can do at every timestep. The temp/berendsen fix
                            rescales the velocities of the atoms every timestep in order to reset
                            the temperature.
                        </p>
                        <p>     
                            Since we want to perform a minimization
                            step, both initial and final temperatures have been chosen
                            equal to 1K. The third parameter is the damping factor,
                            in time units, which determines how rapidly the temperature
                            is relaxed. Such damping factor of 1 fs would be too small
                            for a regular molecular dynamics simulation, but is acceptable
                            for a minimization step during which we just want the
                            atoms to move slightly from their initial positions..
                        </p>
                        <p>
                            If we were to run the simulation as it is, it would fail
                            because nothing maintains the shape of the water molecules
                            (and the bond and angle energies are equal to 0). Let us
                            use the shake algorithm in order to maintain the shape of 
                            the molecules. In addition, let us
                            add a fix 'recenter' in order to maintain the system
                            centered in the middle of the box in the \(z\) direction.
                        <pre><code>fix myshk gH2O shake 1.0e-4 200 0 b 1 a 1
fix myrct all recenter NULL NULL INIT</code></pre>
                        </p>
                        <div id="boxtype1">
                            Fix recenter has no influence on the dynamics.
                        </div>
                        <p>
                            Finally, let us choose a small timestep
                            (because we anticipate that the atoms are initially too
                            close to each others) and run for 1000 timesteps (with
                            the command thermo 1000, thermodynamic info are printed
                            in the terminal every 1000 timesteps).
                            <pre><code>timestep 0.5
thermo 50
run 10000
write_data system.data</code></pre>
                        </p>
                        <h4><b>Result</b></h4>
                        <p>
                            When running the input.lammps file, you should see that the total energy of
                            the system decreases as expected (fifth colum):
                            <pre><code> Step   Temp          E_pair         E_mol          TotEng         Press     
    0   0             -99554.799      0             -99554.799     -1008.4767    
50   3.492673      -107825.17      0             -107786.32     -19733.701    
100   2.6260191     -108926.18      0             -108896.97     -20225.668    
150   2.2025292     -109692.83      0             -109668.34     -20319.962 
(...)
9800   1.0233163     -120975.23      0             -120963.85     -12590.345    
9850   1.022532      -120988.11      0             -120976.74     -12582.803    
9900   1.0222164     -121000.48      0             -120989.11     -12573.028    
9950   1.0215887     -121012.78      0             -121001.42     -12562.843    
10000   1.0206449     -121024.53      0             -121013.18     -12551.132 </code></pre>
                        </p>
                        <div id="boxtype2">
                            You can easily import log file into python using the lammps_logfile tool:
                        </div>
                        <p>
                            <img src="../figures/03-NanoshearedElectrolyte/total_energy.png" 
                            class="img-fluid" style="width:40%" alt="Energy minimisation of the confined water and salt">
                            <br>
                            <small> Energy extracted from the log file using python and lammps_logfile. </small>
                        </p>
                        <p>
                            If you look at the trajectory using VMD, you will see some of the atoms (the
                            one that where initially in a problematic position) slightly move from each others,
                            as seen in <a href="https://youtu.be/JWGZnFN4TOo"
                            target="_blank">this video</a>.
                        </p>
                    </section>
                    <section id="equilibration">
                        <h2>System equilibration</h2>
                        <p>
                            Now, let us properly equilibrate the system by letting 
                            bot fluid and piston relax. 
                        </p>
                        <p>
                            Create a new folder called Equilibration/, 
                            create a new input file in it. Add the following lines:
                            <pre><code># Initialisation
boundary p p p
units real
atom_style full
bond_style harmonic
angle_style harmonic
pair_style lj/cut/tip4p/long 1 2 1 1 0.1546 12.0
kspace_style pppm/tip4p 1.0e-4

# System definition
read_data ../Minimization/system.data

# Simulation settings
include ../PARM.lammps

# Define groups
group gH2O type 1 2
group gNa type 3
group gCl type 4
group gliquid type 1 2 3 4
group gwall type 5
region rtop block INF INF INF INF 0 INF
region rbot block INF INF INF INF INF 0
group gtop region rtop
group gbot region rbot
group gwalltop intersect gwall gtop
group gwallbot intersect gwall gbot</code></pre>
                        </p>
                        <p>
                            Here several groups to differentiate between solid, liquid (salt+water), 
                            Na\(^+\), etc. have been defined (although not all are used). In addition, 
                            groups containing only the top wall (gwalltop) and the bottom wall (gwallbot)
                            have been created using the intersect keyword: the intersection between all 
                            the atom on the top part of the box (gtop) and all the atom of type 5 (gwall)
                            correspond to the top wall. 
                        </p>
                        <p>
                            Then, add the following lines for the visualisation :
                            <pre><code># visualisation
dump mydmp all atom 1000 dump.lammpstrj
thermo 50
variable walltopz equal xcm(gwalltop,z)
variable wallbotz equal xcm(gwallbot,z)
variable deltaz equal v_walltopz-v_wallbotz
fix myat1 all ave/time 10 10 100 v_deltaz file interwall_distance.dat</code></pre>
                        </p>
                        <p>
                            The two variables allow to extract the centers of mass of the two walls, respectively, and 
                            the deltaz variable calculates the difference between the two centers of mass. 
                        </p>
                        <p>
                            Finally, add the end of the input:
                            <pre><code># Dynamics
fix mynve all nve
compute tliq gliquid temp
fix myber1 gliquid temp/berendsen 300 300 100
fix_modify myber1 temp tliq
compute twall gwall temp
fix myber2 gwall temp/berendsen 300 300 100
fix_modify myber2 temp twall
fix myshk gH2O shake 1.0e-4 200 0 b 1 a 1
fix myrct all recenter NULL NULL INIT

timestep 1.0
run 20000
write_data system.data</code></pre>
                        </p>
                        <p>
                            The main differences with the previous step (minimize) are 
                            <ul>             
                                <li>
                                    1) the timestep is 1 fs instead of 0.5 fs,
                                </li>
                                <li>
                                    2) the thermostating imposes a temperature of 300 K, for which the 
                                    fluid is expected to behave as a liquid,
                                </li>
                                <li>
                                    3) two thermostats are used instead of one: one for the fluid, one for the solid
                                    (fix_modify ensure that the right temperature is used by the temp/berenden).
                                </li>
                            </ul>
                        </p>
                        <p>
                            Run the input script. The distance between the two walls reduces until it reaches an
                            equilibrium value:
                        </p>
                        <p>
                            <img src="../figures/03-NanoshearedElectrolyte/interwalldistance.png" 
                            class="img-fluid" style="width:40%" alt="Energy minimisation of the confined water and salt">
                            <br>
                            <small> Distance between the walls as a function of time. </small>
                        </p>
                    </section>
                    <section id="shearing">
                        <h2>Imposed nanoshearing</h2>
                        <p>
                            From the equilibrated configuration, let us impose the shearing of the two walls. 
                            In a new folder called Shearing/, create a new input that start similarly:
                            <pre><code># Initialisation
boundary p p p
units real
atom_style full
bond_style harmonic
angle_style harmonic
pair_style lj/cut/tip4p/long 1 2 1 1 0.1546 12.0
kspace_style pppm/tip4p 1.0e-4

# System definition
read_data ../Equilibration/system.data
change_box all z final -40 40

# Simulation settings
include ../PARM.lammps

# Groups
group gH2O type 1 2
group gNa type 3
group gCl type 4
group gliquid type 1 2 3 4
group gwall type 5
region rtop block INF INF INF INF 0 INF
region rbot block INF INF INF INF INF 0
group gtop region rtop
group gbot region rbot
group gwalltop intersect gwall gtop
group gwallbot intersect gwall gbot

# Dynamics
fix mynve all nve
compute tliq gliquid temp/partial 0 1 1
fix myber1 gliquid temp/berendsen 300 300 100
fix_modify myber1 temp tliq
compute twall gwall temp/partial 0 1 1
fix myber2 gwall temp/berendsen 300 300 100
fix_modify myber2 temp twall
fix myshk gH2O shake 1.0e-4 200 0 b 1 a 1
fix myrct all recenter NULL NULL INIT</code></pre>      
                        </p>
                        <p>
                            The main difference with the equilibration step, so far, is the use of temp/partial 0 1 1. 
                            This is meant to exclude the x coordinate from the thermalisation, since a large velocity will be imposed 
                            along \(x\). Another difference is the change_box, used to reduce a little the amount of vacuum along \(z\).
                        </p>
                        <p>
                            Then, let us cancel the forces along \(x\) on each walls, and set the 
                            value of the velocity along \(x\):
                            <pre><code>fix mysf1 gwalltop setforce 0 NULL NULL
fix mysf2 gwallbot setforce 0 NULL NULL
velocity gwallbot set -20e-5 NULL NULL
velocity gwalltop set 20e-5 NULL NULL</code></pre>
                        </p>
                        <div id="boxtype1">
                            Setforce command cancel forced on a group of atom at every timestep, so 
                            the atoms of the group do not experience any force from the rest of the system, 
                            so their velocity never changes.
                        </div>
                        <div id="boxtype2">
                            The velocity set command acts only once. Used in combination with 
                            setforce, the atom will keep that imposed velocity no matter what. 
                        </div>
                        <p>
                            Finally, let us dump the atom positions, extract the velocity profile using the 
                            ave/chunk command, extract the force applied on the walls, and then run for 
                            20 ps:
                            <pre><code># vizualisation
dump mydmp all atom 5000 dump.lammpstrj
thermo 500
thermo_modify temp tliq

compute cc1 gliquid chunk/atom bin/1d z 0.0 1.0
#fix myac1 gliquid ave/chunk 10 15000 200000 cc1 vx file vel.profile.dat # tag:200ps
fix myac1 gliquid ave/chunk 10 1500 20000 cc1 vx file vel.profile.dat # tag:20ps

#fix myat1 all ave/time 10 100 1000 f_mysf1[1] f_mysf2[1] file forces.dat # tag:200ps
fix myat1 all ave/time 10 100 1000 f_mysf1[1] f_mysf2[1] file forces.dat # tag:20ps

timestep 1.0
#run 200000 # tag:200ps
run 20000 # tag:20ps
write_data system.data</code></pre>
                        </p>
                        <div id="boxtype1">
                            20 ps is too short to access meaningull value, so if you want just uncomment the 3 
                            line tagged with "200ps", and comment the lines tagged "20ps".
                        </div>
                        <p>
                            The velocity profile I got (running for 200ps) is the following:
                        </p>
                        <p>
                            <img src="../figures/03-NanoshearedElectrolyte/velocityprofile.png" 
                            class="img-fluid" style="width:40%" alt="Velocity of the nanosheared fluid">
                            <img src="../figures/03-NanoshearedElectrolyte/shearedfluid.webp" 
                            class="img-fluid" style="height:450px" alt="Video of sheared fluid">
                            <br>
                            <small>Velocity profile of the fluid along \(z\). </small>
                        </p>
                        <p>
                            From the force applied by the fluid on the solid, one can extract the stress 
                            within the fluid, which allows one to measure its viscosity \( \dot{\eta} \) according to
                            <a href="https://pure.tudelft.nl/ws/portalfiles/portal/89280267/PhysRevFluids.6.034303.pdf">gravelle2021</a>:
                            \[ \eta = \tau / \dot{\gamma} \]
                            where \( \tau \) is the stress applied bythe fluid on the shearing wall, and \( \dot{\gamma} \) the shear rate (which is imposed here).
                            Here the shear rate is approximatively 6.25e9 s\(^{-1}\), and using a surface area of 1e-17 m\(^2\), I get a viscosity for the fluid
                            equal to 2.25 mPa.s
                        </p>
                        <div id="boxtype2">
                            The viscosity calculated at such high shear rate may differ from the bulk value. I recommand using a 
                            lower shear rate. 
                        </div>
                        <div id="boxtype1">
                            The viscosity of a fluid next to a solid surface is typically larger than in bulk 
                            due to interaction with the walls. 
                        </div>
                        <p>
                            You can access all the input scripts and data files that have been used
                            in this tutorial from
                            <a href="https://github.com/lammpstutorials/lammpstutorials.github.io/tree/main/inputs/03-NanoconfinedElectrolyte/"
                            target="_blank" class="removelinkdefault">Github</a>.
                        </p>
                    </section>
                    <section id="further">
                        <h2>Going further with exercises</h2>
                        <div id="boxtype1">
                            Request the solutions by <a href="../miscellaneous/contact.html">email</a>, or become a <a target="_blank"
                            href="https://www.patreon.com/molecularsimulations">patreon for 1 euro per month</a> and access all the solutions
                            + additional LAMMPS content.
                        </div>
                        <br><h4><b>Exercise 1 : Extract more data from the simulation</b></h4>
                        <p>
                            Perform an equilibrium simulation, and extract both density profiles
                            and diffusion coefficients in all 3 directions of space. 
                        </p>
                        <p>
                            <img src="../figures/03-NanoshearedElectrolyte/Density.jpg"
                            class="img-fluid" alt="Responsive image">
                        </p>
                        <div id="boxtype1">
                            Hint: in general, data extraction can ne done either (1) using the internal LAMMPS 
                            commands (e.g. variable/compute + fix ave/time), or (2) using a post-processing analysis tool (e.g. Python). 
                        </div>
                        <br><h4><b>Exercise 2 : Poiseuille flow</b></h4>
                        <p>
                            Instead of inducing shearing using the walls,  
                            induce a flow of the liquid in the direction tangential to the walls, and extract the 
                            the velocity profile. 
                        </p>
                        <div id="boxtype2">
                            Advice: the forcing must be chosen with care. If too large, the system will
                            be strongly out-of-equilibrium. If too small, no net velocity will be measured
                            because of the thermal noise.  
                        </div>
                        <p>
                            Question: Is the velocity profile you obtain consistent with Poiseuille's predictions?
                        </p>
                        <div id="boxtype1">
                            <a href="../miscellaneous/contact.html">Contact me </a>if you have any question about these tutorials
                            (or about your own project). 
                        </div>
                    </section>
                </div>
            </div>
            <footer id="footer" class="section">
                <div class="container">
                <p class="text-2 text-center mb-0">This template has been adapted from
                <a class="btn-link" target="_blank"
                href="https://github.com/harnishdesign/iDocs/">HarnishDesign</a>.
                </p>
                </div>
            </footer>
        </div>
        <a id="back-to-top" data-toggle="tooltip" title="Back to Top" href="javascript:void(0)"><i class="fa fa-chevron-up"></i></a>
        <script src="../assets_tutorials/vendor/jquery/jquery.min.js"></script>
        <script src="../assets_tutorials/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="../assets_tutorials/vendor/highlight.js/highlight.min.js"></script>
        <script src="../assets_tutorials/vendor/jquery.easing/jquery.easing.min.js"></script>
        <script src="../assets_tutorials/vendor/magnific-popup/jquery.magnific-popup.min.js"></script>
        <script src="../assets_tutorials/js/theme.js"></script>
    </body>
</html>
