<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="../_static/favicon-32x32.png" sizes="32x32" rel="icon" type="image/png"><link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" />
        <link rel="prefetch" href="../_static/logo.png" as="image" />

    <!-- Generated with Sphinx 7.4.7 and Furo 2025.07.19 -->
        <title>Method 1: Free sampling - </title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=25af2a20" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=8dab3a3b" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=b1e702db" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">    </div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/logo.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">    </span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../non-tutorials/scope.html">Scope</a></li>
<li class="toctree-l1"><a class="reference internal" href="../non-tutorials/prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../non-tutorials/contact.html">Contact</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorial1/lennard-jones-fluid.html">Lennard-Jones fluid</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial2/breaking-a-carbon-nanotube.html">Pulling on a carbon nanotube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial3/polymer-in-water.html">Polymer in water</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial4/nanosheared-electrolyte.html">Nanosheared electrolyte</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial5/reactive-silicon-dioxide.html">Reactive silicon dioxide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial6/water-adsorption-in-silica.html">Water adsorption in silica</a></li>
<li class="toctree-l1"><a class="reference internal" href="free-energy-calculation.html">Free energy calculation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial8/reactive-molecular-dynamics.html">Reactive Molecular Dynamics</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Extra content</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../non-tutorials/solutions.html">Solutions to the exercises</a></li>
<li class="toctree-l1"><a class="reference internal" href="../non-tutorials/glossary.html">LAMMPS Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../non-tutorials/bibliography.html">Bibliography</a></li>
<li class="toctree-l1"><a class="reference internal" href="../non-tutorials/using-lammps-gui.html">Using LAMMPS–GUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../non-tutorials/running-lammps.html">Running LAMMPS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../non-tutorials/command-line.html">Command line</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/tutorial7/tutorial.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <div class="info admonition">
<p class="admonition-title">What is free energy</p>
<p>The <em>free energy</em> refers to the potential energy of a system that
is available to perform work. In molecular simulations, it is
common to calculate free energy differences between different states
or conformations of a molecular system. This can be useful in understanding
the thermodynamics of a system, predicting reaction pathways, and
determining the stability of different molecular configurations.</p>
</div>
<section id="method-1-free-sampling">
<h1>Method 1: Free sampling<a class="headerlink" href="#method-1-free-sampling" title="Link to this heading">¶</a></h1>
<p>The most direct way to estimate a free energy profile is to sample
the Boltzmann distribution using a classical (i.e.unbiased) molecular dynamics
simulation, and compute relative Gibbs free energies from the relative probabilities
of states using</p>
<div class="math-wrapper docutils container" id="equation-eq-g">
<div class="math notranslate nohighlight" id="equation-eq-g">
<span class="eqno">(1)<a class="headerlink" href="#equation-eq-g" title="Link to this equation">¶</a></span>\[\Delta G = -RT \ln(\rho/\rho_0),\]</div>
</div>
<p>where <span class="math notranslate nohighlight">\(\Delta G\)</span> is the free energy difference, <span class="math notranslate nohighlight">\(R\)</span> is the gas constant, <span class="math notranslate nohighlight">\(T\)</span>
is the temperature, <span class="math notranslate nohighlight">\(\rho\)</span> is the density, and <span class="math notranslate nohighlight">\(\rho_0\)</span> is a reference density.
As an illustration, let us apply this method to a simple configuration
that consists of a particles in a box in the presence of a
position-dependent repulsive force that makes the center of the box a less
favorable area to explore.</p>
<div class="patreon admonition">
<p class="admonition-title">Struggling with your molecular simulations project?</p>
<p>Get guidance for your LAMMPS simulations and receive
personalized <a href="https://www.patreon.com/molecularsimulations" target="_blank">advice</a> for your project.</p>
</div>
<section id="basic-lammps-parameters">
<h2>Basic LAMMPS parameters<a class="headerlink" href="#basic-lammps-parameters" title="Link to this heading">¶</a></h2>
<p>To begin this tutorial, if you are using LAMMPS–GUI, select <code class="docutils literal notranslate"><span class="pre">Start</span> <span class="pre">Tutorial</span> <span class="pre">7</span></code>
from the <code class="docutils literal notranslate"><span class="pre">Tutorials</span></code> menu and follow the instructions. Alternatively, if you are
not using LAMMPS–GUI, create a new folder and add a file named
<strong>free-sampling.lmp</strong>. Open the file in a text editor and paste in the following
content:</p>
<div class="highlight-lammps notranslate"><div class="highlight"><pre><span></span><span class="k">variable </span><span class="nv nv-Identifier">sigma</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="m">3.405</span>
<span class="k">variable </span><span class="nv nv-Identifier">epsilon</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="m">0.238</span>
<span class="k">variable </span><span class="nv nv-Identifier">U0</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="m">1.5</span><span class="o">*</span><span class="nv">${epsilon}</span>
<span class="k">variable </span><span class="nv nv-Identifier">dlt</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="m">1.0</span>
<span class="k">variable </span><span class="nv nv-Identifier">x0</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="m">10.0</span>

<span class="k">units</span><span class="w"> </span><span class="n">real</span>
<span class="k">atom_style</span><span class="w"> </span><span class="n">atomic</span>
<span class="k">pair_style</span><span class="w"> </span><span class="n">lj</span><span class="o">/</span><span class="n">cut</span><span class="w"> </span><span class="nv">$(2^(1/6)*v_sigma)</span>
<span class="k">pair_modify</span><span class="w"> </span><span class="n">shift</span><span class="w"> </span><span class="n">yes</span>
<span class="k">boundary</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">p</span>
</pre></div>
</div>
<p>Here, we begin by defining variables for the Lennard-Jones interaction
<span class="math notranslate nohighlight">\(\sigma\)</span> and <span class="math notranslate nohighlight">\(\epsilon\)</span> and for the repulsive potential
<span class="math notranslate nohighlight">\(U\)</span>, which are <span class="math notranslate nohighlight">\(U_0\)</span>, <span class="math notranslate nohighlight">\(\delta\)</span>, and
<span class="math notranslate nohighlight">\(x_0\)</span> [see Eqs. <a class="reference internal" href="#equation-eq-u">(2)</a>-<a class="reference internal" href="#equation-eq-f">(3)</a> below].  The cut-off value of
:math:<cite>2^{1/6} sigma = 3.822</cite> was chosen to create a Weeks-Chandler-Andersen
(WCA) potential, which is a truncated and purely repulsive LJ potential <span id="id1">[<a class="reference internal" href="../non-tutorials/bibliography.html#id18" title="John D Weeks, David Chandler, and Hans C Andersen. Role of repulsive forces in determining the equilibrium structure of simple liquids. The Journal of chemical physics, 54(12):5237–5247, 1971.">52</a>]</span>.
The potential is also shifted to be equal to 0 at the cut-off
using the <code class="docutils literal notranslate"><span class="pre">pair_modify</span></code> command.</p>
<div class="non-title-info admonition">
<p class="admonition-title">Note</p>
<p>The syntax <code class="docutils literal notranslate"><span class="pre">$(...)</span></code>, where a dollar sign is followed by parentheses, allows
you to evaluate a numeric formula immediately, without having to assign it
to a named variable first.</p>
</div>
</section>
<section id="system-creation-and-settings">
<h2>System creation and settings<a class="headerlink" href="#system-creation-and-settings" title="Link to this heading">¶</a></h2>
<p>Let us define the simulation box and randomly add atoms by addying the
following lines to <strong>free-sampling.lmp</strong>:</p>
<div class="highlight-lammps notranslate"><div class="highlight"><pre><span></span><span class="k">region </span><span class="nv nv-Identifier">myreg</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">-</span><span class="m">50</span><span class="w"> </span><span class="m">50</span><span class="w"> </span><span class="o">-</span><span class="m">15</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="o">-</span><span class="m">50</span><span class="w"> </span><span class="m">50</span>
<span class="k">create_box </span><span class="nv nv-Identifier">1</span><span class="w"> </span><span class="nv nv-Identifier">myreg</span>
<span class="k">create_atoms</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="m">200</span><span class="w"> </span><span class="m">34134</span><span class="w"> </span><span class="n">myreg</span><span class="w"> </span><span class="n">overlap</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="n">maxtry</span><span class="w"> </span><span class="m">50</span>

<span class="k">mass</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">39.95</span>
<span class="k">pair_coeff</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">${epsilon}</span><span class="w"> </span><span class="nv">${sigma}</span>
</pre></div>
</div>
<div class="non-title-info admonition">
<p class="admonition-title">Note</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">pair_coeff</span></code> command, the first two asterisks
<code class="docutils literal notranslate"><span class="pre">*</span> <span class="pre">*</span></code> indicate that the parameters apply to all atom types in the simulation.</p>
</div>
<p>The variables <span class="math notranslate nohighlight">\(U_0\)</span>, <span class="math notranslate nohighlight">\(\delta\)</span>, and <span class="math notranslate nohighlight">\(x_0\)</span>, defined in the previous subsection, are
used here to create the repulsive potential, restricting the atoms from exploring
the center of the box:</p>
<div class="math-wrapper docutils container" id="equation-eq-u">
<div class="math notranslate nohighlight" id="equation-eq-u">
<span class="eqno">(2)<a class="headerlink" href="#equation-eq-u" title="Link to this equation">¶</a></span>\[U = U_0 \left[ \arctan \left( \dfrac{x+x_0}{\delta} \right)
- \arctan \left(\dfrac{x-x_0}{\delta} \right) \right].\]</div>
</div>
<p>Taking the derivative of the potential with respect to <span class="math notranslate nohighlight">\(x\)</span>, we obtain the expression
for the force that will be imposed on the atoms:</p>
<div class="math-wrapper docutils container" id="equation-eq-f">
<div class="math notranslate nohighlight" id="equation-eq-f">
<span class="eqno">(3)<a class="headerlink" href="#equation-eq-f" title="Link to this equation">¶</a></span>\[F = \dfrac{U_0}{\delta} \left[ \dfrac{1}{(x-x_0)^2/\delta^2+1}
- \dfrac{1}{(x+x_0)^2/\delta^2+1} \right].\]</div>
</div>
<p>The figure below shows the potential <span class="math notranslate nohighlight">\(U\)</span> and force <span class="math notranslate nohighlight">\(F\)</span> along the <span class="math notranslate nohighlight">\(x\)</span>-axis.
With <span class="math notranslate nohighlight">\(U_0 = 1.5 \epsilon = 0.36\,\text{kcal/mol},\)</span> <span class="math notranslate nohighlight">\(U_0\)</span> is of the same order of magnitude as the
thermal energy <span class="math notranslate nohighlight">\(k_\text{B} T = 0.24\,\text{kcal/mol}\)</span>, where <span class="math notranslate nohighlight">\(k_\text{B} = 0.002\,\text{kcal/mol/K}\)</span>
is the Boltzmann constant and <span class="math notranslate nohighlight">\(T = 119.8\,\text{K}\)</span> is the temperature
used in this simulation.  Under these conditions, particles are expected to
frequently overcome the energy barrier due to thermal agitation.</p>
<figure class="align-default">
<img alt="Potential imporsed to the atoms" class="only-dark" src="../_images/US-potential-dm.png" />
</figure>
<figure class="align-default">
<img alt="Potential imporsed to the atoms" class="only-light" src="../_images/US-potential.png" />
</figure>
<div class="figurelegend docutils container">
<p>Figure: Potential <span class="math notranslate nohighlight">\(U\)</span> given in Eq. <a class="reference internal" href="#equation-eq-u">(2)</a> (a) and force <span class="math notranslate nohighlight">\(F\)</span> given in
Eq. <a class="reference internal" href="#equation-eq-f">(3)</a> (b) as functions of the coordinate <span class="math notranslate nohighlight">\(x\)</span>. Here,
<span class="math notranslate nohighlight">\(U_0 = 0.36~\text{kcal/mol}\)</span>, <span class="math notranslate nohighlight">\(\delta = 1.0~\text{Å}\)</span>, and <span class="math notranslate nohighlight">\(x_0 = 10~\text{Å}\)</span>.</p>
</div>
<p>We impose the force <span class="math notranslate nohighlight">\(F(x)\)</span> to the atoms in the simulation
using the <code class="docutils literal notranslate"><span class="pre">fix</span> <span class="pre">addforce</span></code> command.  Add the following
lines to <strong>free-sampling.lmp</strong>:</p>
<div class="highlight-lammps notranslate"><div class="highlight"><pre><span></span><span class="k">variable </span><span class="nv nv-Identifier">U</span><span class="w"> </span><span class="n">atom</span><span class="w"> </span><span class="nv">${U0}</span><span class="o">*</span><span class="n">atan</span><span class="nv">((x+${x0})/${dlt})</span><span class="o">-</span><span class="nv">${U0}</span><span class="o">*</span><span class="n">atan</span><span class="nv">((x-${x0})/${dlt})</span>
<span class="k">variable </span><span class="nv nv-Identifier">F</span><span class="w"> </span><span class="n">atom</span><span class="w"> </span><span class="nv">${U0}</span><span class="o">/</span><span class="nv">((x-${x0})^2/${dlt}^2+1)</span><span class="o">/</span><span class="nv">${dlt}</span><span class="o">-</span><span class="nv">${U0}</span><span class="o">/</span><span class="nv">((x+${x0})^2/${dlt}^2+1)</span><span class="o">/</span><span class="nv">${dlt}</span>
<span class="k">fix </span><span class="nv nv-Identifier">myadf</span><span class="w"> </span><span class="nv nv-Identifier">all</span><span class="w"> </span><span class="n">addforce</span><span class="w"> </span><span class="n">v_F</span><span class="w"> </span><span class="m">0.0</span><span class="w"> </span><span class="m">0.0</span><span class="w"> </span><span class="n">energy</span><span class="w"> </span><span class="n">v_U</span>
</pre></div>
</div>
<p>Next, we combine the <code class="docutils literal notranslate"><span class="pre">fix</span> <span class="pre">nve</span></code> with a <code class="docutils literal notranslate"><span class="pre">fix</span> <span class="pre">langevin</span></code> thermostat:</p>
<div class="highlight-lammps notranslate"><div class="highlight"><pre><span></span><span class="k">fix </span><span class="nv nv-Identifier">mynve</span><span class="w"> </span><span class="nv nv-Identifier">all</span><span class="w"> </span><span class="n">nve</span>
<span class="k">fix </span><span class="nv nv-Identifier">mylgv</span><span class="w"> </span><span class="nv nv-Identifier">all</span><span class="w"> </span><span class="n">langevin</span><span class="w"> </span><span class="m">119.8</span><span class="w"> </span><span class="m">119.8</span><span class="w"> </span><span class="m">500</span><span class="w"> </span><span class="m">30917</span>
</pre></div>
</div>
<p>When combining these two commands, the MD simulation operates
in the NVT ensemble, maintaining a constant number of
atoms <span class="math notranslate nohighlight">\(N\)</span>, constant volume <span class="math notranslate nohighlight">\(V\)</span>, and a temperature <span class="math notranslate nohighlight">\(T\)</span> that
fluctuates around a target value.</p>
<p>To ensure that the equilibration time is sufficient, we will track the evolution of
the number of atoms in the central - energetically unfavorable - region,
referred to as <code class="docutils literal notranslate"><span class="pre">mymes</span></code>, using the <code class="docutils literal notranslate"><span class="pre">n_center</span></code> variable:</p>
<div class="highlight-lammps notranslate"><div class="highlight"><pre><span></span><span class="k">region </span><span class="nv nv-Identifier">mymes</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">-</span><span class="nv">${x0}</span><span class="w"> </span><span class="nv">${x0}</span><span class="w"> </span><span class="n">INF</span><span class="w"> </span><span class="n">INF</span><span class="w"> </span><span class="n">INF</span><span class="w"> </span><span class="n">INF</span>
<span class="k">variable </span><span class="nv nv-Identifier">n_center</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">count</span><span class="nv">(all,mymes)</span>
<span class="k">thermo_style</span><span class="w"> </span><span class="n">custom</span><span class="w"> </span><span class="n">step</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="n">etotal</span><span class="w"> </span><span class="n">v_n_center</span>
<span class="k">thermo</span><span class="w"> </span><span class="m">10000</span>
</pre></div>
</div>
<p>For visualization, use one of the following options: the <code class="docutils literal notranslate"><span class="pre">dump</span> <span class="pre">image</span></code> command to
create .ppm images of the system, or the <code class="docutils literal notranslate"><span class="pre">dump</span> <span class="pre">atom</span></code> command to write a
VMD-compatible trajectory to a file:</p>
<div class="highlight-lammps notranslate"><div class="highlight"><pre><span></span><span class="c"># Option 1</span>
<span class="k">dump </span><span class="nv nv-Identifier">viz1</span><span class="w"> </span><span class="nv nv-Identifier">all</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="m">50000</span><span class="w"> </span><span class="n">myimage</span><span class="o">-*</span><span class="n">.ppm</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">shiny</span><span class="w"> </span><span class="m">0.1</span><span class="w"> </span><span class="n">box</span><span class="w"> </span><span class="n">yes</span><span class="w"> </span><span class="m">0.01</span><span class="w"> </span><span class="n">view</span><span class="w"> </span><span class="m">180</span><span class="w"> </span><span class="m">90</span><span class="w"> </span><span class="n">zoom</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="m">1600</span><span class="w"> </span><span class="m">500</span><span class="w"> </span><span class="n">fsaa</span><span class="w"> </span><span class="n">yes</span>
<span class="k">dump_modify </span><span class="nv nv-Identifier">viz1</span><span class="w"> </span><span class="n">backcolor</span><span class="w"> </span><span class="n">white</span><span class="w"> </span><span class="n">acolor</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="n">cyan</span><span class="w"> </span><span class="n">adiam</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="n">boxcolor</span><span class="w"> </span><span class="n">black</span>

<span class="c"># Option 2</span>
<span class="k">dump </span><span class="nv nv-Identifier">viz2</span><span class="w"> </span><span class="nv nv-Identifier">all</span><span class="w"> </span><span class="n">atom</span><span class="w"> </span><span class="m">50000</span><span class="w"> </span><span class="n">free</span><span class="o">-</span><span class="n">sampling.lammpstrj</span>
</pre></div>
</div>
<p>Finally, let us perform an equilibration of 50000 steps,
using a timestep of <span class="math notranslate nohighlight">\(2\,\text{fs}\)</span>, corresponding to a total duration of <span class="math notranslate nohighlight">\(100\,\text{ps}\)</span>:</p>
<div class="highlight-lammps notranslate"><div class="highlight"><pre><span></span><span class="k">timestep</span><span class="w"> </span><span class="m">2.0</span>
<span class="k">run</span><span class="w"> </span><span class="m">50000</span>
</pre></div>
</div>
<p>Run the simulation with LAMMPS.  The number of atoms in the
central region, <span class="math notranslate nohighlight">\(n_\mathrm{center}\)</span>, reaches its equilibrium value after approximately <span class="math notranslate nohighlight">\(40\,\text{ps}\)</span>.</p>
<figure class="align-default">
<img alt="Evolution of the number of atoms" class="only-dark" src="../_images/US-density-evolution-dm.png" />
</figure>
<figure class="align-default">
<img alt="Evolution of the number of atoms" class="only-light" src="../_images/US-density-evolution.png" />
</figure>
<div class="figurelegend docutils container">
<p>Figure: Evolution of the number of atoms <span class="math notranslate nohighlight">\(n_\text{center}\)</span> in the central
region <code class="docutils literal notranslate"><span class="pre">mymes</span></code> as a function of time <span class="math notranslate nohighlight">\(t\)</span> during equilibration.  The dark line
is <span class="math notranslate nohighlight">\(n_\text{center} = 22 \exp(-t/160)+5\)</span> and serves as a guide for the eyes.
Here, <span class="math notranslate nohighlight">\(U_0 = 0.36~\text{kcal/mol}\)</span>, <span class="math notranslate nohighlight">\(\delta = 1.0~\text{Å}\)</span>, and <span class="math notranslate nohighlight">\(x_0 = 10~\text{Å}\)</span>.</p>
</div>
</section>
<section id="run-and-data-acquisition">
<h2>Run and data acquisition<a class="headerlink" href="#run-and-data-acquisition" title="Link to this heading">¶</a></h2>
<p>Once the system is equilibrated, we will record the density profile of
the atoms along the <span class="math notranslate nohighlight">\(x\)</span>-axis using the <code class="docutils literal notranslate"><span class="pre">ave/chunk</span></code> command.
Add the following line to <strong>free-sampling.lmp</strong>:</p>
<div class="highlight-lammps notranslate"><div class="highlight"><pre><span></span><span class="c"># undump viz2 # Uncomment this line if you&#39;re using Option 2</span>
<span class="k">reset_timestep</span><span class="w"> </span><span class="m">0</span>

<span class="k">thermo</span><span class="w"> </span><span class="m">200000</span>

<span class="k">compute </span><span class="nv nv-Identifier">cc1</span><span class="w"> </span><span class="nv nv-Identifier">all</span><span class="w"> </span><span class="n">chunk</span><span class="o">/</span><span class="n">atom</span><span class="w"> </span><span class="n">bin</span><span class="o">/</span><span class="m">1</span><span class="n">d</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="m">0.0</span><span class="w"> </span><span class="m">2.0</span>
<span class="k">fix </span><span class="nv nv-Identifier">myac</span><span class="w"> </span><span class="nv nv-Identifier">all</span><span class="w"> </span><span class="n">ave</span><span class="o">/</span><span class="n">chunk</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">20000</span><span class="w"> </span><span class="m">2000000</span><span class="w"> </span><span class="n">cc1</span><span class="w"> </span><span class="n">density</span><span class="o">/</span><span class="n">number</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">free</span><span class="o">-</span><span class="n">sampling.dat</span>

<span class="k">run</span><span class="w"> </span><span class="m">2000000</span>
</pre></div>
</div>
<p>Here, the <code class="docutils literal notranslate"><span class="pre">chunk/atom</span></code> command discretizes the simulation
domain into spatial bins of size 2~AA{} along the <span class="math notranslate nohighlight">\(x\)</span> direction,
and the <code class="docutils literal notranslate"><span class="pre">ave/chunk</span></code> command computes and outputs the number density of
atoms within each bin to the file <strong>free-sampling.dat</strong>.}
The step count is reset to 0 using <code class="docutils literal notranslate"><span class="pre">reset_timestep</span></code> to synchronize it
with the output times of <code class="docutils literal notranslate"><span class="pre">fix</span> <span class="pre">density/number</span></code>.  Run the simulation using
LAMMPS.</p>
<figure class="align-default">
<img alt="Density from umbrella sampling simulations" class="only-dark" src="../_images/system-dark.png" />
</figure>
<figure class="align-default">
<img alt="Density from umbrella sampling simulations" class="only-light" src="../_images/system-light.png" />
</figure>
<div class="figurelegend docutils container">
<p>Figure: Snapshot of the system simulated during the free sampling step of the tutorial.
The atoms density is the lowest in the central part of the box, <code class="docutils literal notranslate"><span class="pre">mymes</span></code>.  Here,
<span class="math notranslate nohighlight">\(U_0 = 0.36~\text{kcal/mol}\)</span>, <span class="math notranslate nohighlight">\(\delta = 1.0~\text{Å}\)</span>, and <span class="math notranslate nohighlight">\(x_0 = 10~\text{Å}\)</span>.</p>
</div>
</section>
<section id="data-analysis">
<h2>Data analysis<a class="headerlink" href="#data-analysis" title="Link to this heading">¶</a></h2>
<p>Once the simulation is complete, the density profile from <strong>free-sampling.dat</strong>
shows that the density in the center of the box is
about two orders of magnitude lower than inside the reservoir.
Next, we plot <span class="math notranslate nohighlight">\(-R T \ln(\rho/\rho_\mathrm{bulk})\)</span>, where <span class="math notranslate nohighlight">\(\rho/\rho_\mathrm{bulk}\)</span>
is the the density ratio,  and compare it
with the imposed potential <span class="math notranslate nohighlight">\(U\)</span> from Eq. <a class="reference internal" href="#equation-eq-u">(2)</a>.
The reference density, <span class="math notranslate nohighlight">\(\rho_\text{bulk} = 0.0009~\text{Å}^{-3}\)</span>,
was estimated by measuring the density of the reservoir from the raw density
profiles.  The agreement between the MD results and the imposed energy profile
is excellent, despite some noise in the central part, where fewer data points
are available due to the repulsive potential.</p>
<figure class="align-default">
<img alt="Density from umbrella sampling simulations" class="only-dark" src="../_images/US-density-dm.png" />
</figure>
<figure class="align-default">
<img alt="Density from umbrella sampling simulations" class="only-light" src="../_images/US-density.png" />
</figure>
<div class="figurelegend docutils container">
<p>Figure: a) Fluid density, <span class="math notranslate nohighlight">\(\rho\)</span>, along the <span class="math notranslate nohighlight">\(x\)</span> direction. b) Potential, <span class="math notranslate nohighlight">\(U\)</span>, as a
function of <span class="math notranslate nohighlight">\(x\)</span> measured using free sampling (disks)
compared to the imposed potential given in Eq. <a class="reference internal" href="#equation-eq-u">(2)</a> (line).
Here, <span class="math notranslate nohighlight">\(U_0 = 0.36~\text{kcal/mol}\)</span>, <span class="math notranslate nohighlight">\(\delta = 1.0~\text{Å}\)</span>, <span class="math notranslate nohighlight">\(x_0 = 10~\text{Å}\)</span>,
and the measured reference density in the reservoir is <span class="math notranslate nohighlight">\(\rho_\text{bulk} = 0.0009~\text{Å}^{-3}\)</span>.</p>
</div>
</section>
<section id="the-limits-of-free-sampling">
<h2>The limits of free sampling<a class="headerlink" href="#the-limits-of-free-sampling" title="Link to this heading">¶</a></h2>
<p>Increasing the value of <span class="math notranslate nohighlight">\(U_0\)</span> reduces the average number of atoms in the central
region, making it difficult to achieve a high-resolution free energy profile.
For example, running the same simulation with <span class="math notranslate nohighlight">\(U_0 = 10 \epsilon\)</span>,
corresponding to <span class="math notranslate nohighlight">\(U_0 \approx 10 k_\text{B} T\)</span>, results in no atoms exploring
the central part of the simulation box during the simulation.
In such a case, employing an enhanced sampling method is recommended, as done in the next section.</p>
</section>
</section>
<section id="method-2-umbrella-sampling">
<h1>Method 2: Umbrella sampling<a class="headerlink" href="#method-2-umbrella-sampling" title="Link to this heading">¶</a></h1>
<p>Umbrella sampling is a biased molecular dynamics method in which
additional forces are added to a chosen atom to force it to explore the
more unfavorable areas of the system
<span id="id2">[<a class="reference internal" href="../non-tutorials/bibliography.html#id9" title="Daan Frenkel and Berend Smit. Understanding molecular simulation: from algorithms to applications. Elsevier, 2023.">6</a>, <a class="reference internal" href="../non-tutorials/bibliography.html#id37" title="Michael P Allen and Dominic J Tildesley. Computer simulation of liquids. Oxford university press, 2017.">7</a>, <a class="reference internal" href="../non-tutorials/bibliography.html#id23" title="Johannes Kästner. Umbrella sampling. Wiley Interdisciplinary Reviews: Computational Molecular Science, 1(6):932–942, 2011.">46</a>]</span>.
Here, to encourage one
of the atoms to explore the central region of the box, we apply a
potential <span class="math notranslate nohighlight">\(V\)</span> and force it to move along the <span class="math notranslate nohighlight">\(x\)</span>-axis. The chosen path
is called the axis of reaction. Several simulations (called windows)
will be conducted with varying positions for the center of the applied
biasing. The results will be analyzed using the weighted histogram
analysis method (WHAM) <span id="id3">[<a class="reference internal" href="../non-tutorials/bibliography.html#id19" title="Shankar Kumar, John M Rosenberg, Djamal Bouzida, Robert H Swendsen, and Peter A Kollman. The weighted histogram analysis method for free-energy calculations on biomolecules. i. the method. Journal of computational chemistry, 13(8):1011–1021, 1992.">53</a>, <a class="reference internal" href="../non-tutorials/bibliography.html#id61" title="Shankar Kumar, John M Rosenberg, Djamal Bouzida, Robert H Swendsen, and Peter A Kollman. Multidimensional free-energy calculations using the weighted histogram analysis method. Journal of Computational Chemistry, 16(11):1339–1350, 1995.">54</a>]</span>, which
allows for the removal of the biasing effect and ultimately deduces the
unbiased free energy profile.</p>
<section id="lammps-input-script">
<h2>LAMMPS input script<a class="headerlink" href="#lammps-input-script" title="Link to this heading">¶</a></h2>
<p>If you are using LAMMPS–GUI, open the file named <strong>umbrella-sampling.lmp</strong>.
Alternatively, if you are not using LAMMPS–GUI, create a new input file
and paste in the following content:</p>
<div class="highlight-lammps notranslate"><div class="highlight"><pre><span></span><span class="k">variable </span><span class="nv nv-Identifier">sigma</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="m">3.405</span>
<span class="k">variable </span><span class="nv nv-Identifier">epsilon</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="m">0.238</span>
<span class="k">variable </span><span class="nv nv-Identifier">U0</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="m">10</span><span class="o">*</span><span class="nv">${epsilon}</span>
<span class="k">variable </span><span class="nv nv-Identifier">dlt</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="m">1.0</span>
<span class="k">variable </span><span class="nv nv-Identifier">x0</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="m">10</span>
<span class="k">variable </span><span class="nv nv-Identifier">k</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="m">0.5</span>

<span class="k">units</span><span class="w"> </span><span class="n">real</span>
<span class="k">atom_style</span><span class="w"> </span><span class="n">atomic</span>
<span class="k">pair_style</span><span class="w"> </span><span class="n">lj</span><span class="o">/</span><span class="n">cut</span><span class="w"> </span><span class="nv">$(2^(1/6)*v_sigma)</span>
<span class="k">pair_modify</span><span class="w"> </span><span class="n">shift</span><span class="w"> </span><span class="n">yes</span>
<span class="k">boundary</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">p</span>
</pre></div>
</div>
<p>The first difference from the previous case is the larger value
for the repulsive potential <span class="math notranslate nohighlight">\(U_0\)</span>, which makes the central area
of the system very unlikely to be visited by free particles.  The second
difference is the introduction of the variable <span class="math notranslate nohighlight">\(k\)</span>, which will be used for
the biasing potential.</p>
<p>Let us create a simulation box with two atom types, including a single particle of type 2,
by adding the following lines to <strong>umbrella-sampling.lmp</strong>:</p>
<div class="highlight-lammps notranslate"><div class="highlight"><pre><span></span><span class="k">region </span><span class="nv nv-Identifier">myreg</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">-</span><span class="m">50</span><span class="w"> </span><span class="m">50</span><span class="w"> </span><span class="o">-</span><span class="m">15</span><span class="w"> </span><span class="m">15</span><span class="w"> </span><span class="o">-</span><span class="m">50</span><span class="w"> </span><span class="m">50</span>
<span class="k">create_box </span><span class="nv nv-Identifier">2</span><span class="w"> </span><span class="nv nv-Identifier">myreg</span>
<span class="k">create_atoms</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="n">single</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span>
<span class="k">create_atoms</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="m">199</span><span class="w"> </span><span class="m">34134</span><span class="w"> </span><span class="n">myreg</span><span class="w"> </span><span class="n">overlap</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="n">maxtry</span><span class="w"> </span><span class="m">50</span>
</pre></div>
</div>
<p>Next, we assign the same mass and LJ parameters to both atom types
1 and 2, and place the atoms of type 2 into a group named <code class="docutils literal notranslate"><span class="pre">topull</span></code>:</p>
<div class="highlight-lammps notranslate"><div class="highlight"><pre><span></span><span class="k">mass</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">39.948</span>
<span class="k">pair_coeff</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nv">${epsilon}</span><span class="w"> </span><span class="nv">${sigma}</span>
<span class="k">group </span><span class="nv nv-Identifier">topull</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="m">2</span>
</pre></div>
</div>
<p>Then, the same potential <span class="math notranslate nohighlight">\(U\)</span> and force <span class="math notranslate nohighlight">\(F\)</span> are applied to all the atoms,
together with the same <code class="docutils literal notranslate"><span class="pre">fix</span> <span class="pre">nve</span></code> and <code class="docutils literal notranslate"><span class="pre">fix</span> <span class="pre">langevin</span></code> commands:</p>
<div class="highlight-lammps notranslate"><div class="highlight"><pre><span></span><span class="k">variable </span><span class="nv nv-Identifier">U</span><span class="w"> </span><span class="n">atom</span><span class="w"> </span><span class="nv">${U0}</span><span class="o">*</span><span class="n">atan</span><span class="nv">((x+${x0})/${dlt})</span><span class="o">-</span><span class="nv">${U0}</span><span class="o">*</span><span class="n">atan</span><span class="nv">((x-${x0})/${dlt})</span>
<span class="k">variable </span><span class="nv nv-Identifier">F</span><span class="w"> </span><span class="n">atom</span><span class="w"> </span><span class="nv">${U0}</span><span class="o">/</span><span class="nv">((x-${x0})^2/${dlt}^2+1)</span><span class="o">/</span><span class="nv">${dlt}</span><span class="o">-</span><span class="nv">${U0}</span><span class="o">/</span><span class="nv">((x+${x0})^2/${dlt}^2+1)</span><span class="o">/</span><span class="nv">${dlt}</span>
<span class="k">fix </span><span class="nv nv-Identifier">myadf</span><span class="w"> </span><span class="nv nv-Identifier">all</span><span class="w"> </span><span class="n">addforce</span><span class="w"> </span><span class="n">v_F</span><span class="w"> </span><span class="m">0.0</span><span class="w"> </span><span class="m">0.0</span><span class="w"> </span><span class="n">energy</span><span class="w"> </span><span class="n">v_U</span>

<span class="k">fix </span><span class="nv nv-Identifier">mynve</span><span class="w"> </span><span class="nv nv-Identifier">all</span><span class="w"> </span><span class="n">nve</span>
<span class="k">fix </span><span class="nv nv-Identifier">mylgv</span><span class="w"> </span><span class="nv nv-Identifier">all</span><span class="w"> </span><span class="n">langevin</span><span class="w"> </span><span class="m">119.8</span><span class="w"> </span><span class="m">119.8</span><span class="w"> </span><span class="m">500</span><span class="w"> </span><span class="m">30917</span>
</pre></div>
</div>
<p>Next, we perform a brief equilibration to prepare for the
umbrella sampling run:</p>
<div class="highlight-lammps notranslate"><div class="highlight"><pre><span></span><span class="k">thermo</span><span class="w"> </span><span class="m">5000</span>

<span class="c"># Option 1</span>
<span class="k">dump </span><span class="nv nv-Identifier">viz1</span><span class="w"> </span><span class="nv nv-Identifier">all</span><span class="w"> </span><span class="n">image</span><span class="w"> </span><span class="m">50000</span><span class="w"> </span><span class="n">myimage</span><span class="o">-*</span><span class="n">.ppm</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="n">shiny</span><span class="w"> </span><span class="m">0.1</span><span class="w"> </span><span class="n">box</span><span class="w"> </span><span class="n">yes</span><span class="w"> </span><span class="m">0.01</span><span class="w"> </span><span class="n">view</span><span class="w"> </span><span class="m">180</span><span class="w"> </span><span class="m">90</span><span class="w"> </span><span class="n">zoom</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="m">1600</span><span class="w"> </span><span class="m">500</span><span class="w"> </span><span class="n">fsaa</span><span class="w"> </span><span class="n">yes</span>
<span class="k">dump_modify </span><span class="nv nv-Identifier">viz1</span><span class="w"> </span><span class="n">backcolor</span><span class="w"> </span><span class="n">white</span><span class="w"> </span><span class="n">acolor</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="n">cyan</span><span class="w"> </span><span class="n">acolor</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="n">red</span><span class="w"> </span><span class="n">adiam</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="n">adiam</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="n">boxcolor</span><span class="w"> </span><span class="n">black</span>

<span class="c"># Option 2</span>
<span class="k">dump </span><span class="nv nv-Identifier">viz2</span><span class="w"> </span><span class="nv nv-Identifier">all</span><span class="w"> </span><span class="n">atom</span><span class="w"> </span><span class="m">50000</span><span class="w"> </span><span class="n">umbrella</span><span class="o">-</span><span class="n">sampling.lammpstrj</span>

<span class="k">timestep</span><span class="w"> </span><span class="m">2.0</span>
<span class="k">run</span><span class="w"> </span><span class="m">50000</span>
</pre></div>
</div>
<p>So far, our code resembles that of Method 1, except for the additional particle
of type 2.  Particles of types 1 and 2 are identical, with the same mass
and LJ parameters.  However, the particle of type 2 will also
be exposed to the biasing potential <span class="math notranslate nohighlight">\(V\)</span>, which forces it to explore the
central part of the box.</p>
<p>Now, we create a loop with 15 steps and progressively move the center of the
bias potential by increments of 0.4 nm.  Add the following lines to <strong>umbrella-sampling.lmp</strong>:</p>
<div class="highlight-lammps notranslate"><div class="highlight"><pre><span></span><span class="k">variable </span><span class="nv nv-Identifier">a</span><span class="w"> </span><span class="n">loop</span><span class="w"> </span><span class="m">15</span>
<span class="k">label </span><span class="sc">loop</span>

<span class="k">variable </span><span class="nv nv-Identifier">xdes</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="m">4</span><span class="o">*</span><span class="nv">${a}</span><span class="o">-</span><span class="m">32</span>
<span class="k">variable </span><span class="nv nv-Identifier">xave</span><span class="w"> </span><span class="n">equal</span><span class="w"> </span><span class="n">xcm</span><span class="nv">(topull,x)</span>
<span class="k">fix </span><span class="nv nv-Identifier">mytth</span><span class="w"> </span><span class="nv nv-Identifier">topull</span><span class="w"> </span><span class="n">spring</span><span class="w"> </span><span class="n">tether</span><span class="w"> </span><span class="nv">${k}</span><span class="w"> </span><span class="nv">${xdes}</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">0</span>

<span class="k">run</span><span class="w"> </span><span class="m">20000</span>

<span class="k">fix </span><span class="nv nv-Identifier">myat1</span><span class="w"> </span><span class="nv nv-Identifier">all</span><span class="w"> </span><span class="n">ave</span><span class="o">/</span><span class="n">time</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="n">v_xave</span><span class="w"> </span><span class="n">v_xdes</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">umbrella</span><span class="o">-</span><span class="n">sampling.</span><span class="nv">${a}</span><span class="n">.dat</span>

<span class="k">run</span><span class="w"> </span><span class="m">200000</span>
<span class="k">unfix </span><span class="nv nv-Identifier">myat1</span>
<span class="k">next </span><span class="nv nv-Identifier">a</span>
<span class="k">jump </span><span class="sc">SELF</span><span class="w"> </span><span class="n">loop</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">spring</span></code> command imposes the additional harmonic potential <span class="math notranslate nohighlight">\(V\)</span> with
the previously defined spring constant <span class="math notranslate nohighlight">\(k\)</span>.  The center of the harmonic
potential, <span class="math notranslate nohighlight">\(x_\text{des}\)</span>, successively takes values
from <span class="math notranslate nohighlight">\(-28\,\text{Å}\)</span> to <span class="math notranslate nohighlight">\(28\,\text{Å}\)</span>.  For each value of <span class="math notranslate nohighlight">\(x_\text{des}\)</span>,
an equilibration step of 40 ps is performed, followed by a step
of 400 ps during which the position of the particle of
type 2 along the <span class="math notranslate nohighlight">\(x\)</span>-axis, <span class="math notranslate nohighlight">\(x_\text{ave}\)</span>, is saved in data files named <strong>umbrella-sampling.i.dat</strong>,
where <span class="math notranslate nohighlight">\(i\)</span> ranges from 1 to 15.  Run the <strong>umbrella-sampling.lmp</strong> file using LAMMPS.</p>
<div class="non-title-info admonition">
<p class="admonition-title">Note</p>
<p>The value of <span class="math notranslate nohighlight">\(k\)</span> should be chosen with care:
if <span class="math notranslate nohighlight">\(k\)</span> is too small the particle won’t follow the biasing potential,
and if <span class="math notranslate nohighlight">\(k\)</span> is too large there will be no overlapping between
the different windows, leading to poor reconstruction of the free energy profile.
See the section <a class="reference internal" href="#side-note-k"><span class="std std-ref">Side note: On the choice of k</span></a>.</p>
</div>
</section>
<section id="wham-algorithm">
<h2>WHAM algorithm<a class="headerlink" href="#wham-algorithm" title="Link to this heading">¶</a></h2>
<p>To generate the free energy profile from the particle positions saved in
the <strong>umbrella-sampling.i.dat</strong> files, we use the
WHAM <span id="id4">[<a class="reference internal" href="../non-tutorials/bibliography.html#id19" title="Shankar Kumar, John M Rosenberg, Djamal Bouzida, Robert H Swendsen, and Peter A Kollman. The weighted histogram analysis method for free-energy calculations on biomolecules. i. the method. Journal of computational chemistry, 13(8):1011–1021, 1992.">53</a>, <a class="reference internal" href="../non-tutorials/bibliography.html#id61" title="Shankar Kumar, John M Rosenberg, Djamal Bouzida, Robert H Swendsen, and Peter A Kollman. Multidimensional free-energy calculations using the weighted histogram analysis method. Journal of Computational Chemistry, 16(11):1339–1350, 1995.">54</a>]</span> algorithm as implemented
by Alan Grossfield <span id="id5">[<a class="reference internal" href="../non-tutorials/bibliography.html#id49" title="Alan Grossfield. An implementation of WHAM: the weighted histogram analysis method version 2.0.10. URL: http://membrane.urmc.rochester.edu/content/wham/.">55</a>]</span>.  You can download it
from <a href="http://membrane.urmc.rochester.edu/?page_id=126" target="_blank">Alan Grossfield</a>’s website.  Make sure you download the WHAM code version
2.1.0 or later which introduces the <code class="docutils literal notranslate"><span class="pre">units</span></code> command-line option
used below. The executable called <code class="docutils literal notranslate"><span class="pre">wham</span></code> generated by following
the instructions from the website must be placed next to
<strong>umbrella-sampling.lmp</strong>.  To apply the WHAM algorithm to our
simulation, we need a metadata file containing:</p>
<ul class="simple">
<li><p>the paths to all the data files,</p></li>
<li><p>the values of <span class="math notranslate nohighlight">\(x_\text{des}\)</span>,</p></li>
<li><p>the values of <span class="math notranslate nohighlight">\(k\)</span>.</p></li>
</ul>
<p>Download the <a href="https://raw.githubusercontent.com/lammpstutorials/lammpstutorials-inputs/refs/heads/main/tutorial7/umbrella-sampling.meta" target="_blank">umbrella-sampling.meta</a> file and save it next to <strong>umbrella-sampling.lmp</strong>.
Then, run the WHAM algorithm by typing the following command in the terminal:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./wham<span class="w"> </span>units<span class="w"> </span>real<span class="w"> </span>-30<span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="m">50</span><span class="w"> </span>1e-8<span class="w"> </span><span class="m">119</span>.8<span class="w"> </span><span class="m">0</span><span class="w"> </span>umbrella-sampling.meta<span class="w"> </span>umbrella-sampling.dat
</pre></div>
</div>
<p>where -30 and 30 are the boundaries, 50 is the number of bins, 1e-8 is the tolerance,
and 119.8 is the temperature in Kelvin.  A file called <strong>umbrella-sampling.dat</strong> is created,
containing the free energy profile in kcal/mol.  The resulting PMF can be compared
with the imposed potential <span class="math notranslate nohighlight">\(U\)</span>, showing excellent agreement.</p>
<figure class="align-default">
<img alt="Density from umbrella sampling simulations" class="only-dark" src="../_images/US-free-energy-dm.png" />
</figure>
<figure class="align-default">
<img alt="Density from umbrella sampling simulations" class="only-light" src="../_images/US-free-energy.png" />
</figure>
<div class="figurelegend docutils container">
<p>Figure: The potential, <span class="math notranslate nohighlight">\(U\)</span>, as a function of <span class="math notranslate nohighlight">\(x\)</span>, measured using umbrella
sampling (disks), is compared to the imposed potential given in Eq. <a class="reference internal" href="#equation-eq-u">(2)</a>
(line).  Parameters are <span class="math notranslate nohighlight">\(U_0 = 2.38~\text{kcal/mol}\)</span>, <span class="math notranslate nohighlight">\(\delta = 1.0~\text{Å}\)</span>,
and <span class="math notranslate nohighlight">\(x_0 = 10~\text{Å}\)</span>.</p>
</div>
<p>Remarkably, this excellent agreement is achieved despite
the very short calculation time and the high value for the energy barrier.
Achieving similar results through free sampling would require performing extremely
long and computationally expensive simulations.</p>
</section>
<section id="side-note-on-the-choice-of-k">
<span id="side-note-k"></span><h2>Side note: On the choice of <span class="math notranslate nohighlight">\(k\)</span><a class="headerlink" href="#side-note-on-the-choice-of-k" title="Link to this heading">¶</a></h2>
<p>One difficult part of umbrella sampling is choosing the value of <span class="math notranslate nohighlight">\(k\)</span>.
Ideally, you want the biasing potential to be strong enough to force
the chosen atom or molecule to move along the chosen axis, while also allowing
fluctuations in its position large enough to ensure some overlap in the
probability density between neighboring positions. Here, as an illustration,
three different values of <span class="math notranslate nohighlight">\(k\)</span> are tested:</p>
<ul class="simple">
<li><p>If <span class="math notranslate nohighlight">\(k\)</span> is too small, the biasing potential is too weak to
force the particle to explore the region of interest, making it
impossible to reconstruct the PMF (see panel a in the figure below).</p></li>
<li><p>If <span class="math notranslate nohighlight">\(k\)</span> is “appropriate”, the particle explores the entire axis,
and the probability distributions are strongly impacted by the
potential one wants to probe, as shown in panel b.</p></li>
<li><p>If <span class="math notranslate nohighlight">\(k\)</span> is too large, the biasing potential dominates over the
potential one wants to probe, which reduces the
sensitivity of the method (panel c).</p></li>
</ul>
<figure class="align-default">
<img alt="Averaged density profile" class="only-light" src="../_images/overlap-light.png" />
</figure>
<figure class="align-default">
<img alt="Averaged density profile" class="only-dark" src="../_images/overlap-dark.png" />
</figure>
<div class="figurelegend docutils container">
<p>Figure: Probability density for each run with <span class="math notranslate nohighlight">\(k = 0.15\,\text{kcal}/\text{mol}/\mathrm{Å}^2\)</span> (a)
(a value that is too small to bring the particle into the central region),
<span class="math notranslate nohighlight">\(k = 1.5\,\text{kcal}/\text{mol}/\mathrm{Å}^2\)</span> (b) (a value that allows the particle to explore
the entire path), and <span class="math notranslate nohighlight">\(k = 15\,\text{kcal}/\text{mol}/\mathrm{Å}^2\)</span> (c) (a value so strong that
it becomes difficult to perceive the effect of the probed potential).</p>
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            Made with 
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Method 1: Free sampling</a><ul>
<li><a class="reference internal" href="#basic-lammps-parameters">Basic LAMMPS parameters</a></li>
<li><a class="reference internal" href="#system-creation-and-settings">System creation and settings</a></li>
<li><a class="reference internal" href="#run-and-data-acquisition">Run and data acquisition</a></li>
<li><a class="reference internal" href="#data-analysis">Data analysis</a></li>
<li><a class="reference internal" href="#the-limits-of-free-sampling">The limits of free sampling</a></li>
</ul>
</li>
<li><a class="reference internal" href="#method-2-umbrella-sampling">Method 2: Umbrella sampling</a><ul>
<li><a class="reference internal" href="#lammps-input-script">LAMMPS input script</a></li>
<li><a class="reference internal" href="#wham-algorithm">WHAM algorithm</a></li>
<li><a class="reference internal" href="#side-note-on-the-choice-of-k">Side note: On the choice of <span class="math notranslate nohighlight">\(k\)</span></a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=46bd48cc"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>